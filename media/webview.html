<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'none'; script-src 'nonce-%NONCE%'; style-src 'unsafe-inline';"
  >
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PromptGen</title>
</head>
<body>
  <!-- –¢–∞–±-–ø–∞–Ω–µ–ª—å -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="files">–§–∞–π–ª—ã</button>
    <button class="tab-btn"    data-tab="rules">–ü—Ä–∞–≤–∏–ª–∞</button>
    <button class="tab-btn"    data-tab="task">–ó–∞–¥–∞—á–∞</button>
  </div>

  <!-- –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π -->
  <div class="content">
    <!-- –¢–∞–± –§–∞–π–ª—ã -->
    <div class="tab-panel" id="files">
      <div id="file-tree"></div>
    </div>

    <!-- –¢–∞–± –ü—Ä–∞–≤–∏–ª–∞ -->
    <div class="tab-panel hidden" id="rules">
      <h3>–ü—Ä–∞–≤–∏–ª–∞</h3>
      <textarea id="rules-text" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞..." ></textarea>
    </div>

    <!-- –¢–∞–± –ó–∞–¥–∞—á–∞ -->
    <div class="tab-panel hidden" id="task">
      <h3>–ó–∞–¥–∞—á–∞</h3>
      <textarea id="task-text" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É..." ></textarea>
    </div>
  </div>

  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div class="footer">
    <button id="generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <script nonce="%NONCE%">
    const vscode = acquireVsCodeApi();
    const tree = %FILETREE%;

    // --- –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Ç–∞–±–∞–º ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelector('.tab-btn.active').classList.remove('active');
        btn.classList.add('active');
        // —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      });
    });

    // --- –†–µ–Ω–¥–µ—Ä —Ñ–∞–π–ª–æ–≤–æ–≥–æ –¥–µ—Ä–µ–≤–∞ ---
    function renderTree(nodes, container) {
      const ul = document.createElement('ul');
      for (const node of nodes) {
        const li = document.createElement('li');
        if (node.type === 'dir') {
          const span = document.createElement('span');
          span.textContent = 'üìÅ ' + node.name;
          span.className = 'dir-name';
          span.onclick = () => nestedUl.classList.toggle('hidden');
          li.append(span);
          const nestedUl = document.createElement('ul');
          nestedUl.classList.add('nested', 'hidden');
          renderTree(node.children, nestedUl);
          li.append(nestedUl);
        } else {
          const label = document.createElement('label');
          label.className = 'file-label';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = node.fullPath || node.name;
          label.append(cb, document.createTextNode(node.name));
          li.append(label);
        }
        ul.append(li);
      }
      container.append(ul);
    }
    const fileContainer = document.getElementById('file-tree');
    renderTree(tree, fileContainer);

    // --- –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π ---
    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }
    ['rules-text','task-text'].forEach(id => {
      const ta = document.getElementById(id);
      ta.style.width = '100%';
      ta.style.boxSizing = 'border-box';
      ta.style.overflow = 'hidden';
      ta.addEventListener('input', () => autoResize(ta));
      autoResize(ta);
    });

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ---
    document.getElementById('generate').addEventListener('click', () => {
      const checkedEls = document.querySelectorAll('#files input[type=checkbox]:checked');
      const files = Array.from(checkedEls).map(el => el.value);
      const rules = document.getElementById('rules-text').value;
      const task  = document.getElementById('task-text').value;
      vscode.postMessage({
        command: 'generate',
        files,
        customText: `–ü—Ä–∞–≤–∏–ª–∞:\n${rules}\n\n–ó–∞–¥–∞—á–∞:\n${task}\n\n`
      });
    });

    // --- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
    window.addEventListener('message', event => {
      if (event.data.command === 'result') {
        vscode.postMessage({ command: 'copy', payload: event.data.payload });
      }
    });
  </script>

  <style>
    :root {
      --bg: var(--vscode-editor-background);
      --fg: var(--vscode-editor-foreground);
      --input-bg: var(--vscode-input-background);
      --input-fg: var(--vscode-input-foreground);
      --border: var(--vscode-input-border);
      --hover: var(--vscode-list-hoverBackground);
      --btn-bg: var(--vscode-button-background);
      --btn-fg: var(--vscode-button-foreground);
      --btn-hover: var(--vscode-button-hoverBackground);
    }

    body {
      margin: 0;
      padding: 0;
      color: var(--fg);
      background: var(--bg);
      font-family: var(--vscode-editor-font-family);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* –¢–∞–±-–ø–∞–Ω–µ–ª—å */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 8px;
      background: var(--bg);
      color: var(--fg);
      border: none;
      border-right: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }
    .tab-btn:last-child { border-right: none; }
    .tab-btn.active {
      background: var(--input-bg);
      font-weight: bold;
    }

    /* –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å */
    .content {
      flex: 1;
      overflow: auto;
      padding: 8px;
    }
    .tab-panel.hidden { display: none; }

    /* –§–∞–π–ª–æ–≤–æ–µ –¥–µ—Ä–µ–≤–æ */
    ul { list-style: none; margin: 0; padding-left: 16px; }
    .nested { padding-left: 16px; }
    .dir-name {
      cursor: pointer;
      display: block;
      padding: 2px 4px;
      user-select: none;
    }
    .dir-name:hover { background: var(--hover); }
    .file-label {
      display: flex;
      align-items: center;
      padding: 2px 4px;
      cursor: pointer;
      user-select: none;
    }
    .file-label:hover { background: var(--hover); }
    .file-label input { margin-right: 8px; }

    /* –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è */
    textarea {
      background: var(--input-bg);
      color: var(--input-fg);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 4px;
      font-family: var(--vscode-editor-font-family);
      font-size: var(--vscode-editor-font-size);
      resize: none;
      margin-top: 4px;
    }

    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    .footer {
      padding: 8px;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }
    .footer button {
      width: 100%;
      padding: 8px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
      font-size: 1rem;
    }
    .footer button:hover {
      background: var(--btn-hover);
    }
  </style>
</body>
</html>
