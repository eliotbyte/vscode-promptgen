<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; script-src 'nonce-%NONCE%'; style-src 'unsafe-inline';"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</h2>
    <div id="file-tree"></div>

    <h2>–¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ</h2>
    <textarea
      id="custom-text"
      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏..."
    ></textarea>
    <br /><br />
    <button id="generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>

    <script nonce="%NONCE%">
      const vscode = acquireVsCodeApi();
      const tree = %FILETREE%;

      function renderTree(nodes, container) {
        const ul = document.createElement('ul');
        for (const node of nodes) {
          const li = document.createElement('li');
          if (node.type === 'dir') {
            const span = document.createElement('span');
            span.textContent = 'üìÅ ' + node.name;
            span.style.cursor = 'pointer';
            span.onclick = () => nestedUl.classList.toggle('hidden');
            li.append(span);

            const nestedUl = document.createElement('ul');
            nestedUl.style.paddingLeft = '16px';
            nestedUl.classList.add('hidden');
            node.children.forEach(child => renderTree([child], nestedUl));
            li.append(nestedUl);
          } else {
            const label = document.createElement('label');
            label.className = 'file-label';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = node.fullPath || node.name; // –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            label.append(cb, document.createTextNode(node.name));
            li.append(label);
          }
          ul.append(li);
        }
        container.append(ul);
      }

      const container = document.getElementById('file-tree');
      renderTree(tree, container);

      // –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
      const textarea = document.getElementById('custom-text');
      textarea.style.width = '100%';
      textarea.style.boxSizing = 'border-box';
      textarea.style.overflow = 'hidden';
      function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }
      textarea.addEventListener('input', autoResize);
      autoResize();

      document.getElementById('generate').addEventListener('click', () => {
        const checkedEls = document.querySelectorAll('input[type=checkbox]:checked');
        const files = Array.from(checkedEls).map(el => el.value);
        const customText = textarea.value;
        vscode.postMessage({ command: 'generate', files, customText });
      });

      window.addEventListener('message', event => {
        if (event.data.command === 'result') {
          vscode.postMessage({ command: 'copy', payload: event.data.payload });
        }
      });
    </script>

    <style>
      body {
        margin: 0;
        padding: 16px;
        color: var(--vscode-editor-foreground);
        background-color: var(--vscode-editor-background);
        font-family: var(--vscode-editor-font-family);
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º —É–≥–æ–ª–æ–∫ —Ä–µ—Å–∞–π–∑–∞ */
      textarea {
        width: 100%;
        box-sizing: border-box;
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        border: 1px solid var(--vscode-input-border);
        resize: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —É–≥–æ–ª–æ–∫ */
        overflow: hidden; /* –ß–∏—Å—Ç–æ–µ –∞–≤—Ç–æ—Ä–∞–∑–º–µ—Ä–∏–≤–∞–Ω–∏–µ */
      }

      /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Ñ–∞–π–ª */
      .file-label:hover {
        background: var(--vscode-list-hoverBackground);
      }

      /* –ö–Ω–æ–ø–∫–∞ –∫–∞–∫ VS Code */
      button {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: 1px solid var(--vscode-button-border);
        padding: 4px 12px;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: var(--vscode-button-hoverBackground);
      }
    </style>
  </body>
</html>
